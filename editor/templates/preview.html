{% extends "base.html" %}

{% block content %}
<div style="margin-bottom: 1rem;">
    <a href="/" class="btn">← Back to Editor</a>
</div>

<div class="card">
    <div class="card-header">
        <h2>Site Preview</h2>
        <p>Preview your Hit By A Bus Plan site and download options</p>
    </div>
    <div class="card-content">
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
            <a href="http://localhost:8000" target="_blank" class="btn btn-success">Open Live Site</a>
            <a href="http://localhost:8000/Hit-By-A-Bus-Plan.pdf" target="_blank" class="btn">Download PDF</a>
            <a href="/api/rebuild" class="btn">Rebuild Site</a>
        </div>

        <div class="alert alert-info">
            <strong>Preview Tips:</strong><br>
            • The live site opens in a new tab at <code>http://localhost:8000</code><br>
            • Changes are automatically rebuilt in the background<br>
            • The PDF is regenerated with each build<br>
            • Use your browser's print function for additional PDF options
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Site Status</h3>
    </div>
    <div class="card-content">
        <div id="status-display">
            <p>Loading status...</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>Embedded Preview</h3>
        <p>Quick preview of your site (may take a moment to load)</p>
    </div>
    <div class="card-content">
        <iframe
            src="http://localhost:8000"
            width="100%"
            height="600px"
            style="border: 1px solid #ddd; border-radius: 4px;"
            title="Site Preview">
        </iframe>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function updateDetailedStatus() {
    try {
        const response = await fetch('/api/status');
        const status = await response.json();

        const statusDisplay = document.getElementById('status-display');
        statusDisplay.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <h4>Build Status</h4>
                    <p>
                        <span class="status-indicator ${status.rebuild_in_progress ? 'status-warning' : (status.site_built ? 'status-success' : 'status-error')}"></span>
                        ${status.rebuild_in_progress ? 'Rebuilding...' : (status.site_built ? 'Site built successfully' : 'Build failed')}
                    </p>
                    <p>Content files: ${status.content_files}</p>
                </div>
                <div>
                    <h4>Output Files</h4>
                    <p>
                        <span class="status-indicator ${status.site_built ? 'status-success' : 'status-error'}"></span>
                        HTML Site: ${status.site_built ? 'Available' : 'Not built'}
                    </p>
                    <p>
                        <span class="status-indicator ${status.pdf_exists ? 'status-success' : 'status-error'}"></span>
                        PDF Export: ${status.pdf_exists ? 'Available' : 'Not generated'}
                    </p>
                </div>
            </div>
        `;
    } catch (e) {
        document.getElementById('status-display').innerHTML = `
            <p style="color: #e74c3c;">Error loading status: ${e.message}</p>
        `;
    }
}

// Update status immediately and every 3 seconds
updateDetailedStatus();
setInterval(updateDetailedStatus, 3000);

// Handle rebuild button
document.addEventListener('click', async (e) => {
    if (e.target.href && e.target.href.includes('/api/rebuild')) {
        e.preventDefault();

        const btn = e.target;
        const originalText = btn.textContent;
        btn.textContent = 'Rebuilding...';
        btn.disabled = true;

        try {
            await fetch('/api/rebuild');
            btn.textContent = 'Rebuild Queued!';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (e) {
            btn.textContent = 'Error';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        }
    }
});
</script>
{% endblock %}
